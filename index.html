<link rel="manifest" href="/manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js');
  }
</script>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <meta name="format-detection" content="telephone=no">
    <title>â¤ï¸ è¦ä¸€ç›´åœ¨é€¸ç¦ â¤ï¸</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #ffc2d1 0%, #ffafcc 25%, #f4acb7 50%, #ffe5ec 75%, #ffcad4 100%);
            background-size: 400% 400%;
            animation: gradientMove 25s ease infinite;
            background-attachment: fixed;
            color: #fff;
            overflow-x: hidden;
            position: relative;
        }
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(8px);
            z-index: -1;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='1' fill='%23ffffff' opacity='0.5'/%3E%3C/svg%3E");
            background-size: 15px;
            z-index: -2;
            pointer-events: none;
        }

        /* éªŒè¯æ¨¡å— */
        .verify-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.65);
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        .verify-box {
            max-width: 500px;
            width: 90%;
            padding: 40px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 0 40px rgba(255, 143, 171, 0.3);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .verify-box h1 {
            font-size: 2rem;
            margin-bottom: 40px;
            text-shadow: 0 0 15px #ff8fab;
            color: #fff;
        }
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.1rem;
            color: #ff8fab;
            text-shadow: 0 0 5px rgba(255, 143, 171, 0.5);
        }
        .input-group input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.25);
            color: #fff;
            font-size: 1rem;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .input-group input::placeholder {
            color: #e0e0e0;
        }
        #verify-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(90deg, #ffafcc, #f4acb7);
            color: #fff;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            box-shadow: 0 5px 15px rgba(255, 143, 171, 0.4);
        }
        #verify-btn:hover {
            background: linear-gradient(90deg, #f4acb7, #ff8fab);
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(255, 143, 171, 0.5);
        }
        #verify-tip {
            margin-top: 20px;
            font-size: 1rem;
            min-height: 20px;
            text-shadow: 0 0 5px rgba(0,0,0,0.3);
        }

        /* ä¸»é¡µæ¨¡å— */
        .home-container {
            display: none;
            opacity: 0;
            transition: opacity 0.8s ease;
            padding-bottom: 50px;
        }
        .header {
            text-align: center;
            padding: 50px 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            margin: 0 20px 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 30px rgba(255, 143, 171, 0.2);
        }
        .header h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #ff8fab;
            color: #fff;
        }
        .days {
            font-size: 1.5rem;
            color: #ff8fab;
            text-shadow: 0 0 10px rgba(255, 143, 171, 0.6);
        }
        /* ç…§ç‰‡è½®æ’­ */
        .photo-carousel {
            max-width: 800px;
            margin: 30px auto;
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(255, 143, 171, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .carousel-inner {
            display: flex;
            width: 100%;
            height: 450px;
            transition: transform 0.8s ease;
        }
        .carousel-item {
            flex: 0 0 100%;
            width: 100%;
            height: 100%;
        }
        .carousel-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .carousel-btn:hover {
            background: rgba(255, 143, 171, 0.8);
            box-shadow: 0 0 15px #ff8fab;
        }
        .prev-btn { left: 20px; }
        .next-btn { right: 20px; }
        /* è¡¨ç™½æ–‡æ¡ˆ */
        .content {
            max-width: 800px;
            margin: 30px auto;
            padding: 30px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 0 30px rgba(255, 143, 171, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .content p {
            font-size: 1.2rem;
            line-height: 2;
            margin-bottom: 20px;
            text-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        /* ç•™è¨€æ¿ */
        .message-board {
            max-width: 800px;
            margin: 30px auto;
            padding: 30px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 0 30px rgba(255, 143, 171, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .message-board h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #ff8fab;
            text-shadow: 0 0 15px #ff8fab;
        }
        .message-input {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        .message-input input, .message-input textarea {
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.25);
            color: #fff;
            font-size: 1rem;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .message-input textarea {
            height: 120px;
            resize: none;
        }
        /* æ–‡ä»¶ä¸Šä¼  */
        .file-upload {
            padding: 10px;
            border: 2px dashed #ff8fab;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: rgba(255, 143, 171, 0.1);
        }
        .file-upload:hover {
            background: rgba(255, 143, 171, 0.2);
            border-color: #f4acb7;
        }
        .file-upload input {
            display: none;
        }
        .file-upload-text {
            color: #ff8fab;
            font-size: 0.9rem;
            text-shadow: 0 0 5px rgba(255, 143, 171, 0.5);
        }
        .upload-tips {
            font-size: 0.8rem;
            color: #e0e0e0;
            margin-top: 5px;
        }
        .preview-container {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .preview-item {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .preview-item img, .preview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 143, 171, 0.8);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            z-index: 1;
        }
        .preview-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            color: #fff;
            font-size: 12px;
        }
        .message-input button {
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(90deg, #ffafcc, #f4acb7);
            color: #fff;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 5px 15px rgba(255, 143, 171, 0.4);
        }
        .message-input button:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .message-input button .loading {
            display: none;
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
        }
        .message-input button.loading .loading {
            display: inline-block;
        }
        .message-list {
            max-height: 500px;
            overflow-y: auto;
            gap: 20px;
            display: flex;
            flex-direction: column;
        }
        .message-item {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border-left: 5px solid #ff8fab;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        .message-item .name {
            font-weight: bold;
            color: #ff8fab;
            margin-bottom: 5px;
            text-shadow: 0 0 5px rgba(255, 143, 171, 0.5);
        }
        .message-item .time {
            font-size: 0.8rem;
            color: #e0e0e0;
            margin-bottom: 10px;
        }
        .message-item .content {
            margin-bottom: 10px;
            background: transparent;
            box-shadow: none;
            padding: 0;
            border: none;
        }
        /* ç•™è¨€æ–‡ä»¶é¢„è§ˆ */
        .message-file-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .message-file-item {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .message-file-item img, .message-file-item video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        /* åŠ¨æ€çˆ±å¿ƒ */
        .heart {
            position: absolute;
            width: 20px;
            height: 20px;
            background: linear-gradient(45deg, #ffafcc, #f4acb7);
            transform: rotate(45deg);
            animation: float 6s ease-in-out forwards;
            opacity: 0;
            box-shadow: 0 0 10px #ff8fab;
        }
        .heart::before, .heart::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: linear-gradient(45deg, #ffafcc, #f4acb7);
            border-radius: 50%;
            box-shadow: 0 0 10px #ff8fab;
        }
        .heart::before { top: -10px; left: 0; }
        .heart::after { top: 0; left: -10px; }
        @keyframes float {
            0% { transform: rotate(45deg) translateY(0); opacity: 1; }
            100% { transform: rotate(45deg) translateY(-200px); opacity: 0; }
        }
        /* éŸ³ä¹æ§ä»¶ */
        .music-control {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
            opacity: 0.8;
            transition: opacity 0.3s;
            display: flex;
            gap: 10px;
        }
        .music-control:hover {
            opacity: 1;
        }
        .music-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(90deg, #ffafcc, #f4acb7);
            color: #fff;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(255, 143, 171, 0.4);
        }
        .music-btn:hover {
            background: linear-gradient(90deg, #f4acb7, #ff8fab);
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(255, 143, 171, 0.5);
        }
        #bgmAudio {
            display: none;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .verify-box { padding: 30px; }
            .header h1 { font-size: 2rem; }
            .photo-carousel { margin: 30px 15px; }
            .carousel-inner { height: 250px; }
            .content, .message-board { padding: 20px; margin: 30px 15px; }
            .music-control {
                bottom: 20px;
                right: 20px;
                flex-wrap: wrap;
                justify-content: center;
            }
            .music-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            .message-file-item {
                max-width: 150px;
                max-height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="mask"></div>

    <!-- éªŒè¯æ¨¡å— -->
    <div class="verify-container" id="verifyContainer">
        <div class="verify-box">
            <h1>ğŸ’– å¯¹è‡­å®çš„çªå‡»æé—® ğŸ’–</h1>
            <div class="input-group">
                <label>å“ªå¤©è®¤è¯†å“’ï¼š</label>
                <input type="date" id="meetDate" required>
            </div>
            <div class="input-group">
                <label>æ‹çˆ±æ—¥åˆæ˜¯å“ªå¤©ï¼Ÿï¼š</label>
                <input type="date" id="loveDate" required>
            </div>
            <button id="verify-btn" onclick="checkCode()">è§£é”æˆ‘ä»¬çš„å›å¿†</button>
            <div id="verify-tip"></div>
        </div>
    </div>

    <!-- ä¸»é¡µæ¨¡å— -->
    <div class="home-container" id="homeContainer">
        <audio id="bgmAudio" loop="false"></audio>

        <div class="music-control">
            <button class="music-btn" id="playBtn" onclick="togglePlay()">ğŸµ å”±ï¼(Â´âˆ€ï½€)â™¡</button>
            <button class="music-btn" onclick="nextMusic()">â­ï¸ æ¢é¦–æ­Œ(Â´âˆ€ï½€)â™¡</button>
        </div>

        <div class="header">
            <h1>â¤ï¸ è‡´æœ€çˆ±æ»´å®å® â¤ï¸</h1>
            <div class="days">æˆ‘ä»¬åœ¨ä¸€èµ· <span id="loveDays">0</span> å¤©å•¦ï½</div>
        </div>

        <!-- ç…§ç‰‡è½®æ’­ -->
        <div class="photo-carousel">
            <div class="carousel-inner" id="carouselInner">
                <div class="carousel-item">
                    <img src="https://youke2.picui.cn/s1/2025/12/23/694a8462b3083.jpg" alt="å’Œå®å®ç¬¬ä¸€æ¬¡çº¦ä¼š">
                </div>
                <div class="carousel-item">
                    <img src="https://youke2.picui.cn/s1/2025/12/23/694a808296453.jpg" alt="å’Œå®å®ä¸€èµ·å»æµ·è¾¹">
                </div>
                <div class="carousel-item">
                    <img src="https://youke2.picui.cn/s1/2025/12/23/694a81c8caa67.jpg" alt="ä¿©äººå»åƒé¥­">
                </div>
            </div>
            <button class="carousel-btn prev-btn" onclick="prevSlide()">â†</button>
            <button class="carousel-btn next-btn" onclick="nextSlide()">â†’</button>
        </div>

        <!-- è¡¨ç™½æ–‡æ¡ˆ -->
        <div class="content">
            <p>è‡´ç´«å•§å°å®è´ï¼š</p>
            <p>ä½ çš„å†°ğŸ§Šç»™ä½ æ­å»ºçš„ç‹¬å±æˆ‘ä»¬å“’æƒ…ä¾£ç©ºé—´å™¢</p>
            <p>ç¥å®å®ç”Ÿæ—¥å¿«ä¹å™¢ï¼Œæ°¸è¿œå¼€å¼€å¿ƒå¿ƒï¼Œæ²¡æœ‰çƒ¦æ¼ï¼Œæœ€é‡è¦çš„æ˜¯è¦æ°¸è¿œæ°¸è¿œçˆ±æˆ‘(ãƒ»Îµãƒ»)</p>
        </div>

        <!-- ç•™è¨€æ¿ -->
        <div class="message-board">
            <h2>ğŸ’¬ çˆ±æˆ‘çš„è¯è®°å¾—å¤šè¯´äº›( Ë˜ Â³Ë˜)â™¥</h2>
            <div class="message-input">
                <input type="text" id="name" placeholder="Î¾( âœ¿ï¼â—¡â›)">
                <textarea id="content" placeholder="äººå®¶å¥½æƒ³è¢«ç´«å•§çš„çˆ±çŒæ»¡å‘¢(*Â´âˆ€`)~â™¥ï¼å–å’ªå–å’ª"></textarea>
                <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept="image/*,video/mp4" multiple onchange="handleFileSelect(this)">
                    <div class="file-upload-text">ğŸ“· æ—¶é—´å®šæ ¼æˆ‘ä»¬çš„é‚£äº›ç¬é—´ï¼ˆæœ€å¤š3ä¸ªï¼Œè§†é¢‘â‰¤50MBï¼‰</div>
                    <div class="upload-tips">å›¾ç‰‡è‡ªåŠ¨å‹ç¼©ï¼Œè§†é¢‘è¦å…ˆå‹ç¼©åä¸Šä¼ ï½</div>
                </div>
                <div class="preview-container" id="previewContainer"></div>
                <button id="submitBtn" onclick="addMessage()">
                    <span class="loading">â³ ä¸Šä¼ ä¸­...</span>
                    You  Jumpï¼ŒI  Jumpï¼
                </button>
            </div>
            <div class="message-list" id="messageList"></div>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒé…ç½®
        const MEET_DATE = "2025-05-01";  // è®¤è¯†æ—¥æœŸ
        const LOVE_DATE = "2025-05-16";  // æ‹çˆ±æ—¥æœŸ
        // ä¿®å¤ï¼šéŸ³ä¹åˆ—è¡¨æ•°ç»„æ·»åŠ ç¼ºå¤±çš„é€—å·
        const musicList = [
            "https://upos-sz-estgcos.bilivideo.com/upgcxcode/94/69/1603976994/1603976994-1-192.mp4?e=ig8euxZM2rNcNbRVhwdVhwdlhWdVhwdVhoNvNC8BqJIzNbfq9rVEuxTEnE8L5F6VnEsSTx0vkX8fqJeYTj_lta53NCM=&platform=html5&gen=playurlv3&os=estgcos&og=cos&trid=d2624b1186fa4372a0de739291f192dh&deadline=1766505084&nbs=1&uipk=5&mid=237748271&oi=0x240a42d848001666503092a46775cd55&upsig=af80fb11b684901783f283d3349c07cb&uparams=e,platform,gen,os,og,trid,deadline,nbs,uipk,mid,oi&bvc=vod&nettype=0&bw=295683&agrr=0&buvid=&build=0&dl=0&f=h_0_0&orderid=0,1",
            "https://upos-sz-estgcos.bilivideo.com/upgcxcode/69/72/776947269/776947269-1-208.mp4?e=ig8euxZM2rNcNbhznwdVhwdlhzh3hwdVhoNvNC8BqJIzNbfq9rVEuxTEnE8L5F6VnEsSTx0vkX8fqJeYTj_lta53NCM=&platform=html5&oi=0x240a42d848001666503092a46775cd55&trid=fad8d8b6bba64862aa04ec154ca4723h&os=estgcos&og=cos&deadline=1766505143&uipk=5&mid=237748271&gen=playurlv3&nbs=1&upsig=b6ce87c49ac89539276df97bd588a22c&uparams=e,platform,oi,trid,os,og,deadline,uipk,mid,gen,nbs&bvc=vod&nettype=0&bw=2704058&buvid=&build=0&dl=0&f=h_0_0&agrr=0&orderid=0,1",
        ];
        let currentMusicIndex = 0;
        const bgmAudio = document.getElementById('bgmAudio');
        const playBtn = document.getElementById('playBtn');
        let isMusicInited = false;
        let uploadedFiles = [];
        const MAX_FILES = 3;
        const MAX_VIDEO_SIZE = 50 * 1024 * 1024;

        // 1. éªŒè¯é€»è¾‘
        function checkCode() {
            const meetDate = document.getElementById('meetDate').value;
            const loveDate = document.getElementById('loveDate').value;
            const tip = document.getElementById('verify-tip');
            const verifyContainer = document.getElementById('verifyContainer');
            const homeContainer = document.getElementById('homeContainer');

            // è°ƒè¯•ï¼šæ‰“å°è¾“å…¥çš„æ—¥æœŸï¼Œæ–¹ä¾¿æ’æŸ¥
            console.log('è¾“å…¥çš„è®¤è¯†æ—¥æœŸï¼š', meetDate);
            console.log('è¾“å…¥çš„æ‹çˆ±æ—¥æœŸï¼š', loveDate);
            console.log('æ­£ç¡®çš„è®¤è¯†æ—¥æœŸï¼š', MEET_DATE);
            console.log('æ­£ç¡®çš„æ‹çˆ±æ—¥æœŸï¼š', LOVE_DATE);

            if (!meetDate || !loveDate) {
                tip.innerText = "ç­”ä¸å¯¹å¯æ˜¯æ‰“ä¸å¼€çš„(#`çš¿Â´)";
                tip.style.color = "#ff4500";
                return;
            }

            if (meetDate === MEET_DATE && loveDate === LOVE_DATE) {
                tip.innerText = "å“¼ï¼ä¸è®°å¾—çš„è¯ï¼Œæˆ‘å¯æ˜¯ä¼šç”Ÿæ°”çš„ï¼(#`Ğ”Â´)ï¾‰";
                tip.style.color = "#00ff00";
                setTimeout(() => {
                    verifyContainer.style.display = 'none';
                    homeContainer.style.display = 'block';
                    homeContainer.style.opacity = 1;
                    initHome();
                    initMusic();
                    initMessageBoard();
                }, 1000);
            } else {
                tip.innerText = "(#`Ğ”Â´)ï¾‰(#`Ğ”Â´)ï¾‰(#`Ğ”Â´)ï¾‰ç”Ÿæ°”å•¦ï¼â¤ï¸";
                tip.style.color = "#ff4500";
            }
        }

        // 2. éŸ³ä¹æ’­æ”¾é€»è¾‘
        function initMusic() {
            if (musicList.length === 0) {
                playBtn.innerText = "ğŸµ å“å‘€ï¼Œæ²¡æ­Œäº†";
                return;
            }
            bgmAudio.src = musicList[currentMusicIndex];
            bgmAudio.load();

            bgmAudio.play().then(() => {
                isMusicInited = true;
                playBtn.innerText = "ğŸµ Stop music(â‰§âˆ€â‰¦)ã‚";
            }).catch(err => {
                isMusicInited = false;
                playBtn.innerText = "ğŸµ (â—â€¢á´—â€¢â—)ã‚ä¸‰äºŒä¸€å”±";
            });

            bgmAudio.addEventListener('ended', nextMusic);
        }

        function togglePlay() {
            if (musicList.length === 0) {
                alert("æ²¡æ­Œå•¦Î£ãƒ½(ï¾ŸĞ” ï¾Ÿ; )ï¾‰ï½");
                return;
            }
            if (!isMusicInited) {
                bgmAudio.play().then(() => {
                    isMusicInited = true;
                    playBtn.innerText = "ğŸµ Stop music(â‰§âˆ€â‰¦)ã‚";
                }).catch(err => {
                    alert("æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³ä¹é“¾æ¥æ˜¯å¦æœ‰æ•ˆï½");
                });
                return;
            }
            if (bgmAudio.paused) {
                bgmAudio.play();
                playBtn.innerText = "ğŸµ Stop music(â‰§âˆ€â‰¦)ã‚";
            } else {
                bgmAudio.pause();
                playBtn.innerText = "ğŸµ (â—â€¢á´—â€¢â—)ã‚ä¸‰äºŒä¸€å”±";
            }
        }

        function nextMusic() {
            if (musicList.length === 0) {
                alert("æ²¡æ­Œå•¦Î£ãƒ½(ï¾ŸĞ” ï¾Ÿ; )ï¾‰ï½");
                return;
            }
            currentMusicIndex = (currentMusicIndex + 1) % musicList.length;
            bgmAudio.src = musicList[currentMusicIndex];
            bgmAudio.load();
            if (isMusicInited) {
                bgmAudio.play();
                playBtn.innerText = "ğŸµ Stop music(â‰§âˆ€â‰¦)ã‚";
            }
        }

        // 3. ä¸»é¡µåˆå§‹åŒ–
        function initHome() {
            // è®¡ç®—æ‹çˆ±å¤©æ•°
            function calculateLoveDays() {
                const loveDate = new Date(LOVE_DATE);
                const today = new Date();
                const days = Math.floor((today - loveDate) / (1000 * 60 * 60 * 24));
                document.getElementById('loveDays').innerText = days;
            }
            calculateLoveDays();

            // åŠ¨æ€çˆ±å¿ƒ
            document.addEventListener('click', (e) => {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.style.left = `${e.clientX - 10}px`;
                heart.style.top = `${e.clientY - 10}px`;
                const size = 20 + Math.random() * 20;
                heart.style.width = `${size}px`;
                heart.style.height = `${size}px`;
                const colors = [
                    'linear-gradient(45deg, #ffafcc, #f4acb7)',
                    'linear-gradient(45deg, #ffe5ec, #ffcad4)',
                    'linear-gradient(45deg, #f4acb7, #ff8fab)'
                ];
                heart.style.background = colors[Math.floor(Math.random() * colors.length)];
                document.body.appendChild(heart);
                setTimeout(() => heart.remove(), 6000);
            });

            // ç…§ç‰‡è½®æ’­
            let currentSlide = 0;
            const slides = document.querySelectorAll('.carousel-item');
            const totalSlides = slides.length;

            function goToSlide(index) {
                if (index < 0) currentSlide = totalSlides - 1;
                else if (index >= totalSlides) currentSlide = 0;
                else currentSlide = index;
                document.getElementById('carouselInner').style.transform = `translateX(-${currentSlide * 100}%)`;
            }

            window.prevSlide = function() { goToSlide(currentSlide - 1); };
            window.nextSlide = function() { goToSlide(currentSlide + 1); };

            setInterval(() => { goToSlide(currentSlide + 1); }, 8000);
        }

        // 4. ç•™è¨€æ¿é€»è¾‘
        let db;
        function initMessageBoard() {
            const request = indexedDB.open('YiqiLoveMessageDB', 1);

            request.onupgradeneeded = function(e) {
                db = e.target.result;
                if (!db.objectStoreNames.contains('messages')) {
                    db.createObjectStore('messages', { keyPath: 'id', autoIncrement: true });
                }
            };

            request.onsuccess = function(e) {
                db = e.target.result;
                loadMessages();
            };

            request.onerror = function(e) {
                console.error('IndexedDBåˆå§‹åŒ–å¤±è´¥:', e.target.error);
                const savedMessages = localStorage.getItem('yiqiLoveMessages');
                window.messages = savedMessages ? JSON.parse(savedMessages) : [];
                renderMessages();
            };
        }

        // å›¾ç‰‡å‹ç¼©
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.readAsDataURL(file);

            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;

                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    const maxWidth = 1080;
                    const maxHeight = 1080;
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth/width, maxHeight/height);
                        width = width * ratio;
                        height = height * ratio;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, width, height);

                    const compressedDataUrl = canvas.toDataURL(file.type, 0.8);
                    callback({
                        type: 'image',
                        data: compressedDataUrl,
                        name: file.name,
                        size: Math.round(compressedDataUrl.length * 0.75 / 1024) + 'KB'
                    });
                };
            };
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(input) {
            const files = input.files;
            if (files.length === 0) return;

            if (uploadedFiles.length + files.length > MAX_FILES) {
                alert(`æœ‰${MAX_FILES}ä¸Šé™çš„å•¦`);
                input.value = '';
                return;
            }

            const previewContainer = document.getElementById('previewContainer');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileIndex = uploadedFiles.length + i;

                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.dataset.index = fileIndex;
                previewItem.innerHTML = `<div class="preview-loading">ç¨ç­‰å“¦...</div>`;
                previewContainer.appendChild(previewItem);

                if (file.type.startsWith('video/')) {
                    if (file.size > MAX_VIDEO_SIZE) {
                        alert(`${file.name}è¶…è¿‡50MBå•¦ï½è¯·å‹ç¼©åå†ä¸Šä¼ â¤ï¸`);
                        previewContainer.removeChild(previewItem);
                        continue;
                    }

                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = function(e) {
                        uploadedFiles.push({
                            type: 'video',
                            data: e.target.result,
                            name: file.name,
                            size: Math.round(file.size / 1024) + 'KB'
                        });

                        previewItem.innerHTML = `
                            <video controls src="${e.target.result}" alt="${file.name}"></video>
                            <button class="preview-remove" onclick="removePreview(${fileIndex})">Ã—</button>
                        `;
                    };
                } else if (file.type.startsWith('image/')) {
                    compressImage(file, (compressedFile) => {
                        uploadedFiles.push(compressedFile);

                        previewItem.innerHTML = `
                            <img src="${compressedFile.data}" alt="${file.name}">
                            <button class="preview-remove" onclick="removePreview(${fileIndex})">Ã—</button>
                        `;
                    });
                }
            }

            input.value = '';
        }

        // ç§»é™¤é¢„è§ˆæ–‡ä»¶
        function removePreview(index) {
            uploadedFiles.splice(index, 1);
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = '';

            uploadedFiles.forEach((file, newIndex) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.dataset.index = newIndex;

                if (file.type === 'image') {
                    previewItem.innerHTML = `
                        <img src="${file.data}" alt="${file.name}">
                        <button class="preview-remove" onclick="removePreview(${newIndex})">Ã—</button>
                    `;
                } else {
                    previewItem.innerHTML = `
                        <video controls src="${file.data}" alt="${file.name}"></video>
                        <button class="preview-remove" onclick="removePreview(${newIndex})">Ã—</button>
                    `;
                }

                previewContainer.appendChild(previewItem);
            });
        }

        // åŠ è½½ç•™è¨€
        function loadMessages() {
            if (!db) {
                renderMessages();
                return;
            }

            const transaction = db.transaction(['messages'], 'readonly');
            const store = transaction.objectStore('messages');
            const request = store.getAll();

            request.onsuccess = function(e) {
                window.messages = e.target.result || [];
                renderMessages();
            };

            request.onerror = function(e) {
                console.error('å•Šå’§æ€ä¹ˆçœ‹ä¸åˆ°å•¦(ï¾ŸĞ´ï¾Ÿ):', e.target.error);
                const savedMessages = localStorage.getItem('yiqiLoveMessages');
                window.messages = savedMessages ? JSON.parse(savedMessages) : [];
                renderMessages();
            };
        }

        // æ·»åŠ ç•™è¨€
        window.addMessage = async function() {
            const name = document.getElementById('name').value.trim() || 'åŒ¿å';
            const content = document.getElementById('content').value.trim();
            const submitBtn = document.getElementById('submitBtn');

            if (!content && uploadedFiles.length === 0) {
                alert('å¤¸æˆ‘ä¸¤å¥æ‰è¡Œå™¢ãƒ½(â—Â´Îµï½€â—)ãƒ');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.classList.add('loading');

            const message = {
                name: name,
                content: content,
                time: new Date().toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                }),
                files: [...uploadedFiles]
            };

            try {
                if (db) {
                    const transaction = db.transaction(['messages'], 'readwrite');
                    const store = transaction.objectStore('messages');
                    await new Promise((resolve, reject) => {
                        const request = store.add(message);
                        request.onsuccess = resolve;
                        request.onerror = reject;
                    });
                } else {
                    window.messages.push(message);
                    localStorage.setItem('yiqiLoveMessages', JSON.stringify(window.messages));
                }

                loadMessages();

                document.getElementById('name').value = '';
                document.getElementById('content').value = '';
                uploadedFiles = [];
                document.getElementById('previewContainer').innerHTML = '';

                alert('è¯´çš„ä»€ä¹ˆæˆ‘çœ‹çœ‹Ù©(â™¡Îµâ™¡ )Û¶â¤ï¸');
            } catch (err) {
                console.error('ä¸çŸ¥é“ä¸ºå•¥å¤±è´¥å•¦( ÂºÎ”Âº ):', err);
                alert('é‡è¯•ä¸€ä¸‹( ÂºÏ‰Âº )');
            } finally {
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
            }
        };

        // æ¸²æŸ“ç•™è¨€
        function renderMessages() {
            const messageList = document.getElementById('messageList');
            messageList.innerHTML = '';

            if (!window.messages || window.messages.length === 0) {
                messageList.innerHTML = '<div style="text-align:center; padding:20px; color:#e0e0e0; text-shadow:0 0 5px rgba(0,0,0,0.2);">æš‚æ— ç”œèœœç•™è¨€ï¼Œå¿«æ¥ç»™å®å®å†™ç¬¬ä¸€æ¡å§ï½</div>';
                return;
            }

            const reversedMessages = [...window.messages].reverse();

            reversedMessages.forEach(msg => {
                const item = document.createElement('div');
                item.className = 'message-item';

                let fileHtml = '';
                if (msg.files && msg.files.length > 0) {
                    fileHtml = '<div class="message-file-container">';
                    msg.files.forEach(file => {
                        if (file.type === 'image') {
                            fileHtml += `
                                <div class="message-file-item">
                                    <img src="${file.data}" alt="${file.name}" onclick="openPreview(this)">
                                </div>
                            `;
                        } else {
                            fileHtml += `
                                <div class="message-file-item">
                                    <video controls src="${file.data}" alt="${file.name}"></video>
                                </div>
                            `;
                        }
                    });
                    fileHtml += '</div>';
                }

                item.innerHTML = `
                    <div class="name">${msg.name}</div>
                    <div class="time">${msg.time}</div>
                    <div class="content">${msg.content || ''}</div>
                    ${fileHtml}
                `;

                messageList.appendChild(item);
            });
        }

        // å›¾ç‰‡æ”¾å¤§é¢„è§ˆ
        function openPreview(img) {
            const previewModal = document.createElement('div');
            previewModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                cursor: pointer;
                backdrop-filter: blur(5px);
            `;
            previewModal.innerHTML = `<img src="${img.src}" style="max-width: 90%; max-height: 90%; border-radius: 10px; box-shadow:0 0 30px #ff8fab;">`;
            previewModal.onclick = () => document.body.removeChild(previewModal);
            document.body.appendChild(previewModal);
        }
    </script>
</body>
</html>